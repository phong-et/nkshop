<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <title>Hello, world!</title>
    <style>
        form#form-search .conditions {
            width: 80px;
            margin: 0 10px;
        }

        form#form-search .form-control {
            margin: 0 5px;
        }

        form#form-search input {
            width: 98px !important
        }

        form#form-search label {
            margin-left: 15px;
            font-weight: bold;
            color: green;
        }

        fieldset {
            border: 1px groove #ddd !important;
            padding: 0 1.4em 1.4em 1.4em !important;
            margin: 0 0 1.5em 0 !important;
            -webkit-box-shadow: 0px 0px 0px 0px #000;
            box-shadow: 0px 0px 0px 0px #000;
        }

        legend {
            width: inherit;
            /* Or auto */
            padding: 0 10px;
            /* To give a bit of padding on the left and right */
            border-bottom: none;
        }

        #form-search-control {
            margin-bottom: 20px;
        }

        #form-search-control label {
            padding: 5px;
            margin-right: 30px;
        }
    </style>
</head>

<body>
    <fieldset>
        <legend>
            <h3>NKShop Find Tool</h3>
        </legend>
        <form id="form-search-control" class="form-inline">
            <input type="checkbox" checked id="cbPrice">
            <label>Price</label>
            <input type="checkbox" checked id="cbRatingCount">
            <label>Rating Count</label>
            <input type="checkbox" checked id="cbStatus">
            <label>Status</label>
            <input type="checkbox" checked id="cbPhotoCount">
            <label>Photo Count</label>
            <input type="checkbox" checked id="cbYear">
            <label>Year</label>
            <input type="checkbox" checked id="cbV1">
            <label>V1</label>
            <input type="checkbox" checked id="cbV3">
            <label>V3</label>
            <input type="checkbox" checked id="cbAge">
            <label>Age</label>
        </form>
        <form id="form-search" class="form-inline">
            <label id="lbPrice" style="margin-left:0;">Price: </label>
            <select class="form-control conditions" id="conditionsPrice"></select>
            <select class="form-control" id="ddlPrice"></select>
            <label id="lbRatingCount">Rating: </label>
            <select class="form-control conditions" id="conditionsRatingCount"></select>
            <input type="number" class="form-control" id="txtRatingCount" placeholder="number">
            <select class="form-control" id="ddlStatus">
                <option value="0">Status</option>
                <option value="1">Active</option>
                <option value="2">Off</option>
            </select>
            <label id="lbPhotoCount">Photo: </label>
            <select class="form-control conditions" id="conditionsPhotoCount"></select>
            <select class="form-control" id="ddlPhotoCount">
                <option>Photo</option>
                <option>0</option>
                <option>1</option>
            </select>

            <label id="lbYear">Year: </label>
            <select class="form-control" id="conditionsYear"></select>
            <select class="form-control" id="ddlYear"></select>

            <label id="lbV1">1V: </label>
            <select class="form-control" id="conditionsV1"></select>
            <input type="number" class="form-control" id="txtV1" placeholder="number">

            <label id="lbV3">3V: </label>
            <select class="form-control" id="conditionsV3"></select>
            <input type="number" class="form-control" id="txtV3" placeholder="number">

            <label id="lbAge">Age: </label>
            <select class="form-control" id="conditionsAge"></select>
            <select class="form-control" id="ddlAge">
                <option>Year</option>
            </select>
        </form>
        <button id="btnSearch" style="margin: 10px;" type="button" class="btn btn-primary btn-lg">Search</button>
    </fieldset>


    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

    <script>
        function getQueryConditions() {
            var query = []
            if ($('#cbPrice').is(':checked'))
                query.push(`price ${$('#conditionsPrice option:selected').text()} ${$('#ddlPrice option:selected').text()}`)
            if ($('#cbRatingCount').is(':checked'))
                query.push(`ratingCount ${$('#conditionsRatingCount option:selected').text()} ${$('#txtRatingCount').val()}`)
            if ($('#cbStatus').is(':checked'))
                query.push(`status === ${$('#ddlStatus option:selected').val()}`)
            if ($('#cbPhotoCount').is(':checked'))
                query.push(`photos.length ${$('#conditionsPhotoCount option:selected').text()} ${$('#ddlPhotoCount option:selected').text()}`)
            if ($('#cbYear').is(':checked'))
                query.push(`parseInt(new Date(this.lastUpdateStamp * 1000).toJSON().slice(0,4)) ${$('#conditionsYear option:selected').text()} ${$('#ddlYear option:selected').text()}`)
            if ($('#cbV1').is(':checked') || $('#cbV3').is(':checked') || $('#cbAge').is(':checked')) {
                query.push('attributes !== undefined')
                if ($('#cbV1').is(':checked'))
                    query.push(`attributes['51'] ${$('#conditionsV1 option:selected').text()} ${$('#txtV1').val()}`)
                if ($('#cbV3').is(':checked'))
                    query.push(`attributes['49'] ${$('#conditionsV3 option:selected').text()} ${$('#txtV3').val()}`)
                if ($('#cbAge').is(':checked'))
                    query.push(`new Date(this.attributes['42']*1000).getFullYear() ${$('#conditionsAge option:selected').text()} ${$('#ddlAge option:selected').text()}`)
            }
            return query
        }
        function setDefaultValues() {
            let checkboxsControl = [
                { cbPrice: ['lbPrice', 'conditionsPrice', 'ddlPrice'] },
                { cbRatingCount: ['lbRatingCount', 'conditionsRatingCount', 'txtRatingCount'] },
                { cbStatus: ['ddlStatus'] },
                { cbPhotoCount: ['lbPhotoCount', 'conditionsPhotoCount', 'ddlPhotoCount'] },
                { cbYear: ['lbYear', 'conditionsYear', 'ddlYear'] },
                { cbV1: ['lbV1', 'conditionsV1', 'txtV1'] },
                { cbV3: ['lbV3', 'conditionsV3', 'txtV3'] },
                { cbAge: ['lbAge', 'conditionsAge', 'ddlAge'] }
            ]
            checkboxsControl.forEach(checkbox => {
                var checkboxId = Object.keys(checkbox)[0]
                $('#' + checkboxId).change(function () {
                    let checkboxIsChecked = $('#' + checkboxId).is(':checked')
                    if (checkboxIsChecked) {
                        checkbox[checkboxId].forEach(e => {
                            $('#' + e).show()
                        })
                    } else {
                        checkbox[checkboxId].forEach(e => {
                            $('#' + e).hide()
                            //console.log(component.html())
                        })
                    }
                })
                switch (checkboxId) {
                    case 'cbPrice':
                    case 'cbAge':
                    case 'cbYear':
                        $('#' + checkboxId).prop('checked', true).change();
                        break
                    default:
                        $('#' + checkboxId).prop('checked', false).change();
                        break
                }
            })
        }
        function genConditions() {
            let conditions = ['&gt;=', '&lt;=', '==', '&gt;', '&lt;'],
                ddlIds = [
                    'conditionsPrice', 'conditionsRatingCount',
                    'conditionsPhotoCount', 'conditionsYear',
                    'conditionsV1', 'conditionsV3',
                    'conditionsAge'
                ]
            strHtml = ''
            conditions.forEach(condition => {
                strHtml += `<option>${condition}</option>`
            })
            ddlIds.forEach(ddlId => {
                $('#' + ddlId).html(strHtml)
            })
        }
        function genPrices() {
            let strHtml = ''
            for (let i = 2; i <= 40; i++) {
                strHtml += `<option>${i * 100}</option>`
            }
            $('#ddlPrice').html(strHtml)
        }
        function genYears() {
            let strHtml = ''
            for (let i = new Date().getFullYear(); i >= 2015; i--) {
                strHtml += `<option>${i}</option>`
            }
            $('#ddlYear').html(strHtml)
        }
        function genAges() {
            let strHtml = ''
            for (let i = 101; i >= 86; i--) {
                strHtml += `<option>${1900 + i}</option>`
            }
            $('#ddlAge').html(strHtml)
        }
        function drawProduct(products) {

        }
        $().ready(function () {
            // gen conditions part
            genConditions()
            genPrices()
            genYears()
            genAges()
            setDefaultValues()
            $('#btnSearch').click(function () {
                var query = getQueryConditions()
                $.ajax({
                    url: '/product/',
                    type: 'GET',
                    data: { query: JSON.stringify(query)},
                    success: function (responseText) {
                        try {
                            var records = JSON.parse(responseText);
                            //callback(records)
                        }
                        catch (e) {
                            //callback(e)
                        }
                    },
                    error: function (err) {
                        //alert(err)
                    }
                });
            })
        })
    </script>
</body>

</html>